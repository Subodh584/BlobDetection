#include <WiFi.h>
#include <WebServer.h>

// Motor driver pins
const int AIN1 = 13;
const int AIN2 = 14;
const int BIN1 = 12;
const int BIN2 = 27;
const int PWMA = 26;
const int PWMB = 25;
const int STBY = 33;

// WiFi credentials for Access Point
const char* ssid = "ESP32_Motor_Control";
const char* password = "12345678";

WebServer server(80);a

// Motor speeds (-255 to 255)
int motorASpeed = 0;
int motorBSpeed = 0;

void setup() {
  Serial.begin(115200);
  
  // Initialize motor pins
  pinMode(AIN1, OUTPUT);
  pinMode(AIN2, OUTPUT);
  pinMode(BIN1, OUTPUT);
  pinMode(BIN2, OUTPUT);
  pinMode(PWMA, OUTPUT);
  pinMode(PWMB, OUTPUT);
  pinMode(STBY, OUTPUT);
  
  // Enable motor driver
  digitalWrite(STBY, HIGH);
  
  // Set up Access Point
  WiFi.softAP(ssid, password);
  Serial.println("Access Point Started");
  Serial.print("IP Address: ");
  Serial.println(WiFi.softAPIP());
  
  // Define web server routes
  server.on("/", handleRoot);
  server.on("/control", handleControl);
  server.on("/stop", handleStop);
  
  server.begin();
  Serial.println("Web server started");
}

void loop() {
  server.handleClient();
}

void handleRoot() {
  String html = R"(
<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>ESP32 Motor Control</title>
    <style>
        body { font-family: Arial; text-align: center; margin: 50px; background: #f0f0f0; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 30px; }
        .motor-section { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .speed-control { margin: 15px 0; }
        input[type="range"] { width: 100%; height: 40px; }
        button { padding: 15px 25px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
        .forward { background: #4CAF50; color: white; }
        .backward { background: #f44336; color: white; }
        .stop { background: #ff9800; color: white; }
        .speed-value { font-size: 18px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <div class='container'>
        <h1>üöó Motor Control Panel</h1>
        
        <div class='motor-section'>
            <h3>Motor A (Left)</h3>
            <div class='speed-control'>
                <label>Speed: <span id='speedA' class='speed-value'>0</span></label><br>
                <input type='range' id='motorA' min='-255' max='255' value='0' oninput='updateSpeed("A", this.value)'>
            </div>
            <button class='forward' onclick='setMotor("A", 150)'>Forward</button>
            <button class='backward' onclick='setMotor("A", -150)'>Backward</button>
            <button class='stop' onclick='setMotor("A", 0)'>Stop</button>
        </div>
        
        <div class='motor-section'>
            <h3>Motor B (Right)</h3>
            <div class='speed-control'>
                <label>Speed: <span id='speedB' class='speed-value'>0</span></label><br>
                <input type='range' id='motorB' min='-255' max='255' value='0' oninput='updateSpeed("B", this.value)'>
            </div>
            <button class='forward' onclick='setMotor("B", 150)'>Forward</button>
            <button class='backward' onclick='setMotor("B", -150)'>Backward</button>
            <button class='stop' onclick='setMotor("B", 0)'>Stop</button>
        </div>
        
        <div style='margin-top: 30px;'>
            <button class='forward' onclick='moveForward()'>üîº Both Forward</button><br>
            <button class='backward' onclick='moveBackward()'>üîΩ Both Backward</button><br>
            <button class='forward' onclick='turnLeft()'>‚óÄÔ∏è Turn Left</button>
            <button class='forward' onclick='turnRight()'>‚ñ∂Ô∏è Turn Right</button><br>
            <button class='stop' onclick='stopAll()' style='font-size: 20px; padding: 20px 40px;'>‚èπÔ∏è STOP ALL</button>
        </div>
    </div>

    <script>
        function updateSpeed(motor, speed) {
            document.getElementById('speed' + motor).innerText = speed;
            setMotor(motor, speed);
        }
        
        function setMotor(motor, speed) {
            fetch('/control?motor=' + motor + '&speed=' + speed);
            document.getElementById('motor' + motor).value = speed;
            document.getElementById('speed' + motor).innerText = speed;
        }
        
        function moveForward() {
            setMotor('A', 200);
            setMotor('B', 200);
        }
        
        function moveBackward() {
            setMotor('A', -200);
            setMotor('B', -200);
        }
        
        function turnLeft() {
            setMotor('A', -150);
            setMotor('B', 150);
        }
        
        function turnRight() {
            setMotor('A', 150);
            setMotor('B', -150);
        }
        
        function stopAll() {
            setMotor('A', 0);
            setMotor('B', 0);
        }
    </script>
</body>
</html>
)";
  
  server.send(200, "text/html", html);
}

void handleControl() {
  String motor = server.arg("motor");
  int speed = server.arg("speed").toInt();
  
  if (motor == "A") {
    motorASpeed = speed;
    controlMotorA(speed);
  } else if (motor == "B") {
    motorBSpeed = speed;
    controlMotorB(speed);
  }
  
  Serial.println("Motor " + motor + " speed: " + String(speed));
  server.send(200, "text/plain", "OK");
}

void handleStop() {
  motorASpeed = 0;
  motorBSpeed = 0;
  controlMotorA(0);
  controlMotorB(0);
  server.send(200, "text/plain", "Stopped");
}

void controlMotorA(int speed) {
  if (speed > 0) {
    // Forward
    digitalWrite(AIN1, HIGH);
    digitalWrite(AIN2, LOW);
    analogWrite(PWMA, speed);
  } else if (speed < 0) {
    // Backward
    digitalWrite(AIN1, LOW);
    digitalWrite(AIN2, HIGH);
    analogWrite(PWMA, abs(speed));
  } else {
    // Stop
    digitalWrite(AIN1, LOW);
    digitalWrite(AIN2, LOW);
    analogWrite(PWMA, 0);
  }
}

void controlMotorB(int speed) {
  if (speed > 0) {
    // Forward
    digitalWrite(BIN1, HIGH);
    digitalWrite(BIN2, LOW);
    analogWrite(PWMB, speed);
  } else if (speed < 0) {
    // Backward
    digitalWrite(BIN1, LOW);
    digitalWrite(BIN2, HIGH);
    analogWrite(PWMB, abs(speed));
  } else {
    // Stop
    digitalWrite(BIN1, LOW);
    digitalWrite(BIN2, LOW);
    analogWrite(PWMB, 0);
  }
}
